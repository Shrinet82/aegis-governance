policies:
  - name: aws-s3-block-public-access-realtime
    resource: aws.s3
    description: "Instantly blocks public access on any newly created S3 bucket."
    mode:
      type: cloudtrail
      events:
        - CreateBucket
      role: arn:aws:iam::391183495225:role/Aegis-Governance-Role
    actions:
      - type: set-public-block
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  - name: aws-sg-mark-insecure
    resource: aws.security-group
    description: "Marks any Security Group allowing SSH (22) or RDP (3389) from 0.0.0.0/0 for remediation in 5 minutes."
    mode:
      type: cloudtrail
      events:
        - source: ec2.amazonaws.com
          event: AuthorizeSecurityGroupIngress
          ids: "responseElements.securityGroupRuleSet.items[].groupId"
      role: arn:aws:iam::391183495225:role/Aegis-Governance-Role
    filters:
      - or:
          - type: ingress
            Cidr: "0.0.0.0/0"
            Ports: [22, 3389]
    actions:
      - type: mark-for-op
        op: remove-permissions
        tag: custodian_cleanup
        hours: 0.034 # ~2 Minutes

  - name: aws-sg-remediate-marked
    resource: aws.security-group
    description: "Removes insecure rules from marked Security Groups after the grace period."
    mode:
      type: periodic
      schedule: "rate(1 minute)"
      role: arn:aws:iam::391183495225:role/Aegis-Governance-Role
    filters:
      - type: marked-for-op
        op: remove-permissions
        tag: custodian_cleanup
      # Re-verify the violation still exists before shooting
      - or:
          - type: ingress
            Cidr: "0.0.0.0/0"
            Ports: [22, 3389]
    actions:
      - type: remove-permissions
        ingress: matched
      - type: remove-tag
        tags: ["custodian_cleanup"]
